name: Check Proxies in Parallel (Multi-Protocol)

env:
  PROXY_SOURCES: |
     https://raw.githubusercontent.com/F0rc3Run/F0rc3Run/refs/heads/main/splitted-by-protocol/vmess.txt

  CHECK_ALL_PROXIES: 'true'
  NUM_JOBS: 20

on:
  workflow_dispatch:
  schedule:
    - cron: '0 21 * * *'

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      job_matrix: ${{ steps.split.outputs.job_matrix }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies for preparation
        run: pip install requests
      - name: Download, Deduplicate, Shuffle, and Split Proxies
        id: split
        run: |
          python prepare_proxies.py ${{ env.NUM_JOBS }}
          JOB_MATRIX=$(jq -nc '[range(0; $num)]' --argjson num ${{ env.NUM_JOBS }})
          echo "job_matrix=$JOB_MATRIX" >> $GITHUB_OUTPUT
      - name: Upload proxy chunks
        uses: actions/upload-artifact@v4
        with:
          name: proxy-chunks
          path: proxies_chunk_*.txt

  check:
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        job_index: ${{ fromJson(needs.prepare.outputs.job_matrix) }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Get latest Xray version
        id: get_xray_version
        run: echo "XRAY_VERSION=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest | jq -r .tag_name)" >> $GITHUB_ENV
      - name: Cache Xray binary
        id: cache-xray
        uses: actions/cache@v4
        with:
          path: xray
          key: ${{ runner.os }}-xray-core-${{ env.XRAY_VERSION }}
      - name: Install dependencies
        run: pip install requests
      - name: Download specific proxy chunk
        uses: actions/download-artifact@v4
        with:
          name: proxy-chunks
          path: .
          
      - name: Run proxy check on chunk
        run: |
          INPUT_FILE="proxies_chunk_$(printf "%02d" ${{ matrix.job_index }}).txt"
          OUTPUT_DIR="results_dir_${{ matrix.job_index }}"
          if [ -f "$INPUT_FILE" ]; then
            mkdir -p "$OUTPUT_DIR"
            python check_proxies.py "$INPUT_FILE" "$OUTPUT_DIR"
          else
            echo "Proxy chunk file $INPUT_FILE not found, skipping."
            mkdir -p "$OUTPUT_DIR"
          fi
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: results-batch-${{ matrix.job_index }}
          path: results_dir_${{ matrix.job_index }}/

  collect:
    if: success()
    runs-on: ubuntu-latest
    needs: check
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Download all result batches
        uses: actions/download-artifact@v4
        with:
          pattern: results-batch-*
          path: temp_results/

      - name: Combine results and create detailed & summary commits
        run: |
          set -e
          if [ ! -d "temp_results" ] || [ -z "$(find temp_results -type f -name '*.txt')" ]; then
            echo "No result artifacts were downloaded. Nothing to commit."
            exit 0
          fi

          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          TARGET_DIR="splitted-by-country"
          TEMP_AGGREGATE_DIR="temp_aggregate"
          
          rm -rf "$TEMP_AGGREGATE_DIR"
          mkdir -p "$TEMP_AGGREGATE_DIR"

          find temp_results -type f -name "*.txt" -print0 | while IFS= read -r -d $'\0' file; do
            filename=$(basename "$file")
            cat "$file" >> "$TEMP_AGGREGATE_DIR/$filename"
          done

          git ls-files -z "$TARGET_DIR/" | while IFS= read -r -d $'\0' repo_file; do
            filename=$(basename "$repo_file")
            if [[ "$filename" == "_total.txt" ]]; then continue; fi
            if [ ! -f "$TEMP_AGGREGATE_DIR/$filename" ]; then
              echo "Deleting removed country file: $filename"
              git rm "$repo_file"
            fi
          done
          
          if ! git diff --staged --quiet; then
            git commit -m "chore: Remove country files with no working proxies"
          fi

          # Создаем индивидуальные коммиты для каждого измененного файла страны
          for new_file in "$TEMP_AGGREGATE_DIR"/*.txt; do
            [ -e "$new_file" ] || continue
            filename=$(basename "$new_file")
            dest_file="$TARGET_DIR/$filename"
            
            mkdir -p "$(dirname "$dest_file")"
            
            if [ ! -f "$dest_file" ] || ! cmp -s "$new_file" "$dest_file"; then
              mv "$new_file" "$dest_file"
              proxy_count=$(wc -l < "$dest_file" | awk '{print $1}')
              
              # --- ИЗМЕНЕНИЕ ЗДЕСЬ: Убрана переменная country_name из сообщения коммита ---
              COMMIT_MESSAGE="($(date +'%Y-%m-%d %H:%M')) - ${proxy_count} working"
              
              git add "$dest_file"
              git commit -m "$COMMIT_MESSAGE"
              echo "Committed change for $filename with $proxy_count proxies."
            fi
          done
          
          # Проверяем, были ли какие-либо коммиты (изменения)
          if git rev-list @{u}..HEAD | grep -q .; then
             echo "Changes detected. Creating summary commit..."
             
             TOTAL_PROXIES=$(cat "$TARGET_DIR"/*.txt | wc -l || true)
             
             echo "Total working proxies: $TOTAL_PROXIES" > "$TARGET_DIR/_total.txt"
             git add "$TARGET_DIR/_total.txt"
             
             SUMMARY_COMMIT_MESSAGE="($(date +'%Y-%m-%d %H:%M')) - ${TOTAL_PROXIES} working"
             
             git commit -m "$SUMMARY_COMMIT_MESSAGE"
             
             echo "Pushing all commits..."
             git push
          else
             echo "No new commits to push. The repository is up-to-date."
          fi
