name: Check Proxies in Parallel (Multi-Protocol)

env:
  PROXY_SOURCES: |
     https://raw.githubusercontent.com/F0rc3Run/F0rc3Run/refs/heads/main/splitted-by-protocol/vless.txt
     https://raw.githubusercontent.com/F0rc3Run/F0rc3Run/refs/heads/main/splitted-by-protocol/vmess.txt
     https://raw.githubusercontent.com/F0rc3Run/F0rc3Run/refs/heads/main/splitted-by-protocol/shadowsocks.txt
     https://raw.githubusercontent.com/F0rc3Run/F0rc3Run/refs/heads/main/splitted-by-protocol/trojan.txt
     https://raw.githubusercontent.com/mheidari98/.proxy/refs/heads/main/vless
     https://raw.githubusercontent.com/mheidari98/.proxy/refs/heads/main/vmess
     https://raw.githubusercontent.com/mheidari98/.proxy/refs/heads/main/trojan
     https://raw.githubusercontent.com/mheidari98/.proxy/refs/heads/main/ss


  CHECK_ALL_PROXIES: 'true'

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      job_matrix: ${{ steps.split.outputs.job_matrix }}
    steps:
      - name: Prepare Proxy List
        id: split
        run: |
          echo "Fetching proxies from multiple sources..."
          > combined_proxies.txt
          
          echo "${{ env.PROXY_SOURCES }}" | while IFS= read -r url; do
            if [[ -n "$url" && ! "$url" =~ ^\s*# ]]; then
              echo "-> Processing source: $url"
              # Скачиваем содержимое во временный файл
              curl -s -L "$url" -o temp_source_content.txt

              # --- ИЗМЕНЕНИЕ ЗДЕСЬ: УМНАЯ ОБРАБОТКА ---
              # Проверяем, содержит ли файл обычные ссылки. 
              # Если нет - считаем, что он закодирован в Base64.
              if grep -q '://' temp_source_content.txt; then
                echo "   Format: Plain text. Appending as is."
                cat temp_source_content.txt >> combined_proxies.txt
              else
                echo "   Format: Looks like Base64. Decoding..."
                # Декодируем и дописываем результат. -i игнорирует невалидные символы.
                base64 -d -i temp_source_content.txt >> combined_proxies.txt
              fi
              # ----------------------------------------------

              # Добавляем перенос строки для чистоты
              echo "" >> combined_proxies.txt
            fi
          done

          echo "Removing duplicates and shuffling..."
          # 1. Очищаем от пустых строк
          # 2. Сортируем для удаления текстовых дубликатов
          # 3. ПЕРЕМЕШИВАЕМ (shuf) для равномерного распределения
          grep -v -e '^$' combined_proxies.txt | sort -u | shuf > all_proxies.txt
          
          TOTAL_FETCHED=$(wc -l < all_proxies.txt)
          echo "Total unique proxies fetched: $TOTAL_FETCHED"

          if [ "${{ env.CHECK_ALL_PROXIES }}" = "true" ]; then
            echo "РЕЖИМ: Проверка ВСЕХ прокси."
            cp all_proxies.txt proxies_to_check.txt
          else
            echo "РЕЖИМ: Проверка ПЕРВЫХ 100 прокси."
            head -n 100 all_proxies.txt > proxies_to_check.txt
          fi
          
          echo "Подготовлено к проверке $(wc -l < proxies_to_check.txt) прокси."
          NUM_JOBS=20
          split -d -n l/$NUM_JOBS proxies_to_check.txt proxies_chunk_
          JOB_MATRIX=$(jq -nc '[range(0; $num)]' --argjson num $NUM_JOBS)
          echo "job_matrix=$JOB_MATRIX" >> $GITHUB_OUTPUT

      - name: Upload proxy chunks
        uses: actions/upload-artifact@v4
        with:
          name: proxy-chunks
          path: proxies_chunk_*

  # Задания 'check' и 'collect' остаются БЕЗ ИЗМЕНЕНИЙ
  check:
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        job_index: ${{ fromJson(needs.prepare.outputs.job_matrix) }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Get latest Xray version
        id: get_xray_version
        run: echo "XRAY_VERSION=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest | jq -r .tag_name)" >> $GITHUB_ENV
      - name: Cache Xray binary
        id: cache-xray
        uses: actions/cache@v4
        with:
          path: xray
          key: ${{ runner.os }}-xray-core-${{ env.XRAY_VERSION }}
      - name: Install dependencies
        run: pip install requests
      - name: Download specific proxy chunk
        uses: actions/download-artifact@v4
        with:
          name: proxy-chunks
          path: .
      - name: Run proxy check on chunk
        run: |
          INPUT_FILE="proxies_chunk_$(printf "%02d" ${{ matrix.job_index }})"
          OUTPUT_DIR="results_dir_${{ matrix.job_index }}"
          if [ -f "$INPUT_FILE" ]; then
            mkdir -p "$OUTPUT_DIR"
            python check_proxies.py "$INPUT_FILE" "$OUTPUT_DIR"
          else
            echo "Proxy chunk file $INPUT_FILE not found, skipping."
            mkdir -p "$OUTPUT_DIR"
          fi
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: results-batch-${{ matrix.job_index }}
          path: results_dir_${{ matrix.job_index }}/

  collect:
    runs-on: ubuntu-latest
    needs: check
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Download all result batches
        uses: actions/download-artifact@v4
        with:
          pattern: results-batch-*
          path: temp_results/
      - name: Combine results and push to target repo
        run: |
          set -e
          TARGET_DIR="splitted-by-country"
          mkdir -p "$TARGET_DIR"
          rm -rf "$TARGET_DIR"/*
          find temp_results -type f -name "*.txt" | while read -r file; do
            filename=$(basename "$file")
            cat "$file" >> "$TARGET_DIR/$filename"
          done
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add "$TARGET_DIR/"
          if git diff --staged --quiet
          then
            echo "No changes to commit. The proxy list is up-to-date."
          else
            TOTAL_PROXIES=$(cat "$TARGET_DIR"/*.txt | wc -l || true)
            COMMIT_MESSAGE="Update country-sorted proxies ($(date +'%Y-%m-%d %H:%M')) - ${TOTAL_PROXIES} working"
            git commit -m "$COMMIT_MESSAGE"
            git push
          fi
